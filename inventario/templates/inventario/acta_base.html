{% extends "base.html" %}
{% load static %}
{% load form_extras %}

{% block title %}Acta #{{ acta.id }}{% endblock %}

{% block content %}
<h4 class="mb-3 text-primary fw-semibold">ğŸ“œ Acta #{{ acta.id }}</h4>

<div class="card shadow-sm mb-3 border-0">
  <div class="card-body py-2 px-3 small">
    <div class="row">
      <div class="col-sm-4"><strong>TÃ©cnico:</strong> {{ acta.tecnico }}</div>
      <div class="col-sm-4"><strong>Fecha:</strong> {{ acta.fecha|date:"d/m/Y H:i" }}</div>
      <div class="col-sm-4">
        <strong>Estado:</strong>
        {% if acta.firmada_por_tecnico %}
          <span class="badge bg-success">Firmada</span>
        {% else %}
          <span class="badge bg-warning text-dark">Sin firmar</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} py-2 px-3 mb-2">{{ message }}</div>

    {% if 'firmada correctamente' in message|stringformat:"s" %}
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          setTimeout(function () {
            if (confirm("âœ… El acta fue firmada correctamente.\nÂ¿Desea imprimir el acta ahora?")) {
              window.open("{% url 'inventario:acta_pdf' acta.id %}", "_blank");
            }
          }, 300);
        });
      </script>
    {% endif %}
  {% endfor %}
{% endif %}


{% if not modo_lectura %}
<form method="post" class="row gx-2 gy-2 align-items-end mb-4" style="max-width: 700px;">
  {% csrf_token %}

  <div class="col-md-5 col-sm-6">
    <label for="material" class="form-label small">CÃ³digo de Material</label>
    <input list="materiales-list" name="material" id="material"
           class="form-control form-control-sm" placeholder="Ej: M001" required>
    <datalist id="materiales-list">
      {% for m in materiales %}
        <option value="{{ m.codigo }}">{{ m.codigo }} - {{ m.descripcion }}</option>
      {% endfor %}
    </datalist>
  </div>

  <div class="col-md-3 col-sm-3">
    <label for="cantidad" class="form-label small">Cantidad</label>
    <input type="number" name="cantidad" id="cantidad"
           class="form-control form-control-sm" min="1" required>
  </div>

  <div class="col-md-4 col-sm-3">
    <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">â• Agregar</button>
  </div>
</form>
{% endif %}

<hr class="my-3">
<h6 class="text-primary fw-bold">ğŸ“¦ Materiales Entregados</h6>
<div class="table-responsive">
  <table class="table table-sm table-bordered align-middle mb-3">
    <thead class="table-light small">
      <tr>
        <th>CÃ³digo</th>
        <th>DescripciÃ³n</th>
        <th>Cantidad</th>
        <th>Reparado por</th>
        {% if not acta.firmada_por_tecnico %}<th class="text-center">AcciÃ³n</th>{% endif %}
      </tr>
    </thead>
    <tbody class="small">
      {% for item in detalles %}
        <tr>
          <td>{{ item.material.codigo }}</td>
          <td>{{ item.material.descripcion }}</td>
          <td>{{ item.cantidad }}</td>
          <td>{{ item.reparado_por }}</td>
          {% if not acta.firmada_por_tecnico %}
          <td class="text-center">
            <form method="post" action="{% url 'inventario:eliminar_item_acta' item.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar"
                      onclick="return confirm('Â¿Eliminar este Ã­tem?');">ğŸ—‘ï¸</button>
            </form>
          </td>
          {% endif %}
        </tr>
      {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted">Esta acta no tiene Ã­tems registrados.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if detalles %}
  <div class="card border-0 shadow-sm mt-4">
    <div class="card-body d-flex flex-wrap justify-content-end align-items-center gap-2 py-3 px-3">

      <a href="{% url 'inventario:acta_pdf' acta.id %}" target="_blank"
        class="btn btn-outline-dark btn-sm flex-grow-1 flex-md-grow-0"
        title="Abrir PDF en nueva pestaÃ±a">
        ğŸ–¨ï¸ Vista previa PDF
      </a>

      {% if not acta.firmada_por_tecnico and not modo_lectura %}
        <a href="{% url 'inventario:firmar_acta' acta.pk %}"
          class="btn btn-success btn-sm flex-grow-1 flex-md-grow-0">
          âœ… Firmar y cerrar acta
        </a>
      {% endif %}

      <a href="{% url 'inventario:lista_actas' %}"
        class="btn btn-outline-secondary btn-sm flex-grow-1 flex-md-grow-0">
        â† Volver al listado
      </a>

    </div>
  </div>

{% endif %}



{% endblock %}
